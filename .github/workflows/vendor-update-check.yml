name: Vendor Update Check

on:
  schedule:
    - cron: "0 14 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-vendor-deps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Run vendor version check
        id: check
        run: |
          python3 scripts/check_vendor_updates.py \
            --report-file vendor-update-report.md \
            --github-output "$GITHUB_OUTPUT"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: vendor-update-report
          path: vendor-update-report.md

      - name: Create or update issue when attention is needed
        if: steps.check.outputs.needs_attention == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const title = 'Vendor library updates available';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const report = fs.readFileSync('vendor-update-report.md', 'utf8');
            const body = `${report}\n\n_Run: ${runUrl}_`;
            const { owner, repo } = context.repo;

            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`
            });
            const existing = search.data.items.find((item) => item.title === title);

            if (existing) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: existing.number,
                title,
                body
              });
              core.info(`Updated existing issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title,
                body
              });
              core.info(`Created issue #${created.data.number}`);
            }

      - name: Close stale alert issue when no attention is needed
        if: steps.check.outputs.needs_attention != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'Vendor library updates available';
            const { owner, repo } = context.repo;

            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`
            });
            const existing = search.data.items.find((item) => item.title === title);

            if (!existing) {
              core.info('No open alert issue to close.');
              return;
            }

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: existing.number,
              state: 'closed'
            });
            core.info(`Closed issue #${existing.number} because no updates/errors were detected.`);
